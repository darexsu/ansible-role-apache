---
- name: merge dictionaries
  block:
    - include_vars:
        file: ../../darexsu.apache/defaults/main.yml
        name: apache_default_vars

    - name: merge default and new dictionaries
      set_fact:
        "{{ item.key }}": "{{ apache_default_vars[item.key] | combine(merge[item.key], recursive=True)}}"
      when: apache_default_vars[item.key] is defined
      with_dict: "{{ merge }}"

    - name: combine defaults vars with merge dictionary
      set_fact:
        merge: "{{ apache_default_vars | combine(merge, recursive=True)}}"
  when: merge is defined

- name: apache role is disabled
  meta: end_play
  when: not apache.enabled

- name: include apache install
  include_tasks: ./tasks/install/apache__install.yml
  when: apache_install.enabled

- name: include apache config
  include_tasks: ./tasks/config/apache__conf.yml
  when: apache_conf.enabled

- name: include apache virtualhost config
  include_tasks: ./tasks/config/apache__virtualhost_{{ ansible_os_family }}.yml
  when: apache_virtualhost[item.key]['enabled']
  with_dict: "{{ apache_virtualhost }}"

- name: include apache modules
  include_tasks: ./tasks/config/apache__modules_{{ ansible_os_family }}.yml
  when: apache_modules.enabled

- name: service facts
  ansible.builtin.service_facts:

- name: ensure apache is "{{ apache.service.state }}"
  ansible.builtin.service:
    name: "{{ apache_const[ansible_os_family]['service_name'] }}"
    state: "{{ apache.service.state }}"
    enabled: "{{ apache.service.enabled }}"
  when: ansible_facts.services is search(apache_const[ansible_os_family]['service_name'])